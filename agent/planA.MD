## Expected Min-Max

已有的py benchmark显示, 对于七圣而言, Min-Max作为推理主体已经够用并且十分好用. 我们要做的就是尽量消减不确定性, 然后使用期望MinMax(配合Alpha-beta剪枝).

## 贝叶斯推理

使用贝叶斯推理猜测手牌. 给定游戏状态$\mathcal{S}$和历史知识$\mathcal{K}$, 我们可以推测各卡牌的出现概率.

$$
P\{c_i\mid \mathcal{S}\} = \frac{P\{\mathcal{S}\mid c_i\}}{P\{\mathcal{S}\}}P\{c_i\}
$$

注意到$P\{\mathcal{S}\}$是个常量(对于该局面下所有卡牌而言). 所以我们实际上需要计算的是

$$
P\{c_i\mid \mathcal{S}\} = {P\{\mathcal{S}\mid c_i\}}P\{c_i\}
$$

$P\{c_i\}$完全依赖于知识$\mathcal{K}$. 容易注意到, $P\{\mathcal{S}\mid c_i\}\approx \pi(a\mid c_i)$, 其中$S = S_0(a)$.

> 可能存在其他路径也抵达$S$, 但在七圣中这种概率很小.

策略分布可以通过决策主体得到(无论是MinMax还是MCTS).

但是这还是有个问题; 某些手牌之间可能存在联动, 这会影响到策略分布的计算. 我们利用全概率公式展开, 有

$$
\pi(a\mid c_0) = \sum_{\{c_{j}\}}\left(\pi(a\mid c_0,\cdots, c_n)\prod p(c_i\mid c_0,\cdots, c_{i-1})\right)
$$

求和符号表示对所有可能的组合求和.

这无疑是非常庞大的计算量. 不过, 因为手牌之间存在联动的数量较为有限, 且根据对方阵容, 我们可以排除掉一些概率很低的情况(这需要先验知识$\mathcal{K}$). 就结果而言, 我们可以令大多数的$p(c_i\mid \{c_j\}) = 0$, 并记可能的手牌为$h=\{c_i\}$, 则上述公式可以将求和下标简化为仅对$h$内的组合求和. 特别地, 如果$h$总数小于$n$(对方手牌数), 那么只有一种情况(换句话说, 就是全防). 但如果$|h|$大于$n$, 那么就需要利用以上公式进行计算了.

在实践中, 我们只会考虑$|h|<n$的情况. 

### Update with Game proceeding

当对方打出一张手牌时, 我们就可以获得一些信息, 用来调整我们的先验概率.

$$
P'(c_i) = \frac{P\{\mathcal{S},c'\mid c_i\}}{P\{\mathcal{S,c'}\}}P\{c_i\}
$$

我们的初始先验概率$P_0$可以用七圣Bot的统计数据近似.

$P\{\mathcal{S},c'\mid c_i\}$指的是, *如果他有* 手牌$c_i$, 在$S$状态下, 打出$c'$的概率.

注意, 打出$c'$是我们观察到的事件. 这其实对应着一个行动$a_{c'}$, 换句话说

$$
P\{\mathcal{S},c'\mid c_i\} = \pi_{S}(a_{c'}\mid c_i)
$$

最后, 注意到$P\{\mathcal{S}, c'\}$对于 **本次** 更新是一个常数, 所以我们可以计算出所有的 $P\{\mid\}\cdot P$, 然后归一化得到新的先验概率. 这一步是必要的, 因为之后状态就变了, 不能再将分母视作常数.
